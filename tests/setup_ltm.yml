---
- name: Manage F5 LTM
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    action: "{{ f5.action }}"
    vip_info: "{{ f5.vip_info }}"
    f5_connection_info:
      server: "{{ f5.server }}"
      server_port: "{{ f5.server_port }}"
      user: "{{ f5.user }}"
      password: "{{ f5.password }}"
      validate_certs: "{{ f5.validate_certs }}"

  tasks:
    - name: Create a pool
      bigip_pool:
        state: present
        provider: "{{ f5_connection_info }}"
        lb_method: "{{ vip_info.pool_lb_method }}"
        name: "{{ vip_info.pool_name }}"
    
    - name: Create pool members
      bigip_pool_member:
        state: present
        provider: "{{ f5_connection_info }}"
        description: "{{ item.name }}"
        name: "{{ item.name }}"
        host: "{{ item.host }}"
        pool: "{{ vip_info.pool_name }}"
        port: "{{ item.port }}"
      with_items: "{{ vip_info.pool_members }}"

    - name: Create virtual server
      bigip_virtual_server:
        state: present
        provider: "{{ f5_connection_info }}"
        description: "{{ vip_info.description }}"
        destination: "{{ vip_info.destination }}"
        name: "{{ vip_info.name }}"
        pool: "{{ vip_info.pool_name }}"
        profiles: "{{ vip_info.profiles }}"
        snat: "{{ vip_info.snat }}"
        port: "{{ vip_info.port }}"
